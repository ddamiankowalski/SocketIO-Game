<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO app/game</title>
</head>
<body>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io();

    let localPlayerInfo, localPlayerId;
    let keyD = false, keyW = false, keyA = false, keyS = false;

    socket.on('addPlayersData', (res, playerInfo, id) => {
        localPlayerInfo = res;

        // rendering the new element on screen for already existing clients
        let newSquare = document.createElement('div');
        newSquare.id = `${id}`;
        newSquare.style.height = '10px';
        newSquare.style.width = '10px';
        newSquare.style.backgroundColor = 'red';
        newSquare.style.position = 'absolute';
        newSquare.style.top = `${playerInfo.yPos}px`;
        newSquare.style.left = `${playerInfo.xPos}px`;
        newSquare.className = 'square';

        document.body.appendChild(newSquare);
    })

    socket.on('deletePlayersData', (res, id) => {
        localPlayerInfo = res;

        // delete element from html DOM
        let allSquares = document.getElementsByClassName('square');
        for(let square of allSquares) {
            if(id == square.id) {
                square.remove();
            }
        }
    })

    socket.on('refreshData', (res) => {
        localPlayerInfo = res;
        localPlayerInfo.forEach(square => {
            if(square.playerId != localPlayerId) {
                let elementToChange = document.getElementById(`${square.playerId}`);
                elementToChange.style.top = square.yPos + 'px';
                elementToChange.style.left = square.xPos + 'px';
            }  
        })
    })

    socket.on('renderAllOther', (res, id) => {
        localPlayerId = id;
        res.forEach(square => {
            if(id != square.playerId) {
                // rendering every existing element on screen for the newly connected client
                let newSquare = document.createElement('div');
                newSquare.id = `${square.playerId}`;
                newSquare.style.height = '10px';
                newSquare.style.width = '10px';
                newSquare.style.backgroundColor = 'red';
                newSquare.style.position = 'absolute';
                newSquare.style.top = `${square.yPos}px`;
                newSquare.style.left = `${square.xPos}px`;
                newSquare.className = 'square';

                document.body.appendChild(newSquare);
            }
        })
    })

    function renderPlayers(playersInfo) {
        localPlayerInfo = playersInfo;
    }

    // listening for WSAD movement
    window.addEventListener('keydown', keyDownHandler, false);
    window.addEventListener('keyup', keyUpHandler, false);

    function keyDownHandler(ev) {
        ev.preventDefault();
        let keyCode = ev.keyCode;
        switch (keyCode) {
            case 68:
                keyD = true;
                break;
            case 83: 
                keyS = true;
                break;
            case 65:
                keyA = true;
                break;
            case 87:
                keyW = true;
                break;
        }
    }

    function keyUpHandler(ev) {
        ev.preventDefault();
        let keyCode = ev.keyCode;
        switch (keyCode) {
            case 68:
                keyD = false;
                break;
            case 83: 
                keyS = false;
                break;
            case 65:
                keyA = false;
                break;
            case 87:
                keyW = false;
                break;
        }
    }

    window.setInterval(() => {
        if(keyD) {
            let elementToMove = document.getElementById(localPlayerId);
            elementToMove.style.left = elementToMove.getBoundingClientRect().left + 1 + 'px';
            
            // emit the information about the square's location back to the server
            socket.volatile.emit('changePos', localPlayerId, elementToMove.getBoundingClientRect().left, elementToMove.getBoundingClientRect().top);
        }else if(keyA) {
            let elementToMove = document.getElementById(localPlayerId);
            elementToMove.style.left = elementToMove.getBoundingClientRect().left - 1 + 'px';
            
            // emit the information about the square's location back to the server
            socket.volatile.emit('changePos', localPlayerId, elementToMove.getBoundingClientRect().left, elementToMove.getBoundingClientRect().top);
        } else if(keyS) {
            let elementToMove = document.getElementById(localPlayerId);
            elementToMove.style.top = elementToMove.getBoundingClientRect().top + 1 + 'px';
            
            // emit the information about the square's location back to the server
            socket.volatile.emit('changePos', localPlayerId, elementToMove.getBoundingClientRect().left, elementToMove.getBoundingClientRect().top);
        } else if(keyW) {
            let elementToMove = document.getElementById(localPlayerId);
            elementToMove.style.top = elementToMove.getBoundingClientRect().top - 1 + 'px';
            
            // emit the information about the square's location back to the server
            socket.volatile.emit('changePos', localPlayerId, elementToMove.getBoundingClientRect().left, elementToMove.getBoundingClientRect().top);
        }
    }, 1)
</script>
</html>